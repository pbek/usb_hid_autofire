{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Flipper: 1. Prepare FW workspace",
            "type": "shell",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; FW_DIR=\"${workspaceFolder}/../flipperzero-firmware\"; APP_ID=\"usb_hid_autofire\"; APP_DST=\"$FW_DIR/applications_user/$APP_ID\"; if [ ! -d \"$FW_DIR/.git\" ]; then git clone --recursive --depth 1 https://github.com/flipperdevices/flipperzero-firmware.git \"$FW_DIR\"; fi; mkdir -p \"$FW_DIR/applications_user\"; if [ -e \"$APP_DST\" ] && [ ! -L \"$APP_DST\" ]; then echo \"ERROR: $APP_DST exists and is not a symlink. Move/remove it once, then rerun.\"; exit 1; fi; ln -sfn \"${workspaceFolder}\" \"$APP_DST\"; cd \"$FW_DIR\"; ./fbt -h >/dev/null; echo \"FW ready at $FW_DIR\""
            ],
            "problemMatcher": []
        },
        {
            "label": "Flipper: 2. Build FAP",
            "type": "shell",
            "dependsOn": "Flipper: 1. Prepare FW workspace",
            "dependsOrder": "sequence",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; cd \"${workspaceFolder}/../flipperzero-firmware\"; ./fbt fap_usb_hid_autofire"
            ],
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "problemMatcher": []
        },
        {
            "label": "Flipper: 3. Build + Launch on device",
            "type": "shell",
            "dependsOn": "Flipper: 1. Prepare FW workspace",
            "dependsOrder": "sequence",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; cd \"${workspaceFolder}/../flipperzero-firmware\"; ./fbt launch APPSRC=applications_user/usb_hid_autofire || ./fbt launch_app APPSRC=usb_hid_autofire"
            ],
            "problemMatcher": []
        },
        {
            "label": "Flipper: 4. Lint",
            "type": "shell",
            "dependsOn": "Flipper: 1. Prepare FW workspace",
            "dependsOrder": "sequence",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; cd \"${workspaceFolder}/../flipperzero-firmware\"; ./fbt lint lint_py lint_img"
            ],
            "problemMatcher": []
        },
        {
            "label": "Flipper: 5. Package FAP to dist",
            "type": "shell",
            "dependsOn": "Flipper: 2. Build FAP",
            "dependsOrder": "sequence",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; APP_ID=\"usb_hid_autofire\"; FW_DIR=\"${workspaceFolder}/../flipperzero-firmware\"; SRC=\"$(find \"$FW_DIR/build\" -type f -path \"*/.extapps/${APP_ID}.fap\" | head -n 1)\"; [ -n \"$SRC\" ] || { echo \"FAP not found\"; exit 1; }; VERSION=\"$(grep \"^#define VERSION \" \"${workspaceFolder}/version.h\" | cut -d\\\" -f2)\"; [ -n \"$VERSION\" ] || { echo \"VERSION not found\"; exit 1; }; mkdir -p \"${workspaceFolder}/dist\"; OUT=\"${workspaceFolder}/dist/${APP_ID}-v${VERSION}.fap\"; cp -f \"$SRC\" \"$OUT\"; echo \"Packaged: $OUT\""
            ],
            "problemMatcher": []
        },
        {
            "label": "Flipper: 6. Export dist to Windows",
            "type": "shell",
            "dependsOn": "Flipper: 5. Package FAP to dist",
            "dependsOrder": "sequence",
            "command": "bash",
            "args": [
                "-lc",
                "set -euo pipefail; DEST=\"${input:windows_out_dir}\"; mkdir -p \"$DEST\"; cp -f \"${workspaceFolder}/dist/\"*.fap \"$DEST\"; echo \"Copied to $DEST\""
            ],
            "problemMatcher": []
        }
    ],
    "inputs": [
        {
            "id": "windows_out_dir",
            "type": "promptString",
            "description": "Windows destination path (via /mnt/c/...)",
            "default": "/mnt/c/Users/<your-user>/Downloads/flipper-artifacts"
        }
    ]
}
